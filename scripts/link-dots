#!/usr/bin/env python3

import shutil
import os
import subprocess
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent.resolve()
REPO_ROOT = SCRIPT_DIR.parent
DOTFILES_SOURCE = REPO_ROOT / "caelestia-config"
HOME = Path.home()
XDG_CONFIG = HOME / ".config"

if os.geteuid() == 0:
    print("âŒ Don't run with SUDO!")
    exit(1)

FILES = {
        # --- For directories --- #
        "caelestia": XDG_CONFIG / "caelestia",
        "swappy": XDG_CONFIG / "swappy",
        "Pictures": HOME / "Pictures",
        "Videos": HOME / "Videos",
        "Documents": HOME / "Documents",

        # --- For files --- #
        "fish_greeting.fish": XDG_CONFIG / "fish/functions/fish_greeting.fish",
        ".bash_profile": HOME / ".bash_profile",
        "auto-tty-login.conf": Path("/etc/systemd/system/getty@tty1.service.d/override.conf"),
        "pacman.conf": Path("/etc/pacman.conf")
}

def install():
    print(f"ðŸ“‚ Repo Root:   {REPO_ROOT}")
    print(f"ðŸ“¦ Source Dir:  {DOTFILES_SOURCE}")
    print("-" * 40)

    if not REPO_ROOT.exists():
        print("âŒ Error: Missing root repo directory!")
        return

    XDG_CONFIG.mkdir(parents=True, exist_ok=True)

    repo_conf_path = DOTFILES_SOURCE / "caelestia/repo-path.conf"

    try:
        with open(repo_conf_path, "w") as f:
            f.write(f"$root_dir = {REPO_ROOT}\n")
        print(f"ðŸ“ Generated path config: {repo_conf_path}")
    except Exception as e:
        print(f"ðŸ’€ Failed to generate path config: {e}")

    for filename, target in FILES.items():
        source = DOTFILES_SOURCE / filename
        
        if not source.exists():
            source = REPO_ROOT / filename
        
        if not source.exists():
            print(f"âŒ Missing: {filename} (can't find source)")
            continue

        try:
            is_inside_home = target.is_relative_to(HOME)
        except AttributeError:
            is_inside_home = str(target).startswith(str(HOME))
        except ValueError:
            is_inside_home = False

        if not is_inside_home:
            print(f"ðŸ”’ Outside HOME detected: {target} (SUDO Mode)")
            try:
                subprocess.run(["sudo", "mkdir", "-p", str(target.parent)], check=True)
                subprocess.run(["sudo", "ln", "-sf", str(source), str(target)], check=True)
                if "systemd" in str(target):
                    print("âš™ï¸  Reloading systemd daemon...")
                    subprocess.run(["sudo", "systemctl", "daemon-reload"], check=True)
                    
                print(f"ðŸ”— Linked (Sudo): {filename} -> {target}")

            except subprocess.CalledProcessError as e:
                print(f"ðŸ’€ Sudo command failed for {filename}: {e}")
            
            continue

        if not target.parent.exists():
            try:
                target.parent.mkdir(parents=True, exist_ok=True)
                print(f"ðŸ“ Created dir: {target.parent}")
            except Exception as e:
                print(f"ðŸ’€ Error creating dir {target.parent}: {e}")
                continue

        if target.exists() or target.is_symlink():
            try:
                if target.is_dir() and not target.is_symlink():
                    shutil.rmtree(target)
                else:
                    target.unlink()
                print(f"â™»ï¸  Overriding: {target.name}")
            except Exception as e:
                print(f"ðŸ’€ Failed to nuke {target.name}: {e}")
                continue

        target.symlink_to(source)
        print(f"ðŸ”— Linked: {filename} -> {target}")

    print("-" * 40)
    print("âœ¨ All goods.")

if __name__ == "__main__":
    install()
