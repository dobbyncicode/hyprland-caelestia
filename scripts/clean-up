#!/usr/bin/env python3

import subprocess
import sys
import os
import shutil
import glob

LOG_LIMIT = "50M" 

PATHS_TO_NUKE = [
    # --- Custom cleanup directories --- #
    "~/.cache",
    "~/.thumbnails",
    "~/.local/share/Trash",
    "/root/.cache",
    "/root/.local/share/Trash",
]

def get_free_space_mb():
    total, used, free = shutil.disk_usage("/")
    return free / (1024 * 1024)

def format_size(mb):
    if mb >= 1024:
        return f"{mb / 1024:.2f} GB"
    return f"{mb:.2f} MB"

def check_sudo_access():
    if os.geteuid() == 0:
        print("âš ï¸  Running as `sudo` is not recommended.")
        sys.exit(1)

    print("ðŸ”‘ Acquiring sudo privileges before cleaning up...")
    try:
        subprocess.run(["sudo", "-v"], check=True)
    except subprocess.CalledProcessError:
        sys.exit("ðŸ’€ Sudo auth failed. Cannot proceed.")

def run_cmd(cmd, shell=False):
    subprocess.run(
        cmd, 
        check=True, 
        shell=shell, 
        stdout=subprocess.DEVNULL, 
        stderr=subprocess.PIPE
    )

def nuke_orphans():
    print("ðŸ—‘ï¸  Hunting orphans...")
    while True:
        res = subprocess.run(["yay", "-Qtdq"], capture_output=True, text=True)
        orphans = res.stdout.strip().splitlines()

        if not orphans or orphans == ['']:
            break
        
        print(f"   Found {len(orphans)} orphans. Yeeting...")
        cmd = ["yay", "-Rns", "--noconfirm"] + orphans
        try:
            subprocess.run(cmd, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.PIPE)
        except subprocess.CalledProcessError:
            print("   âš ï¸  Stuck orphan detected. Moving on.")
            break

def clean_pacman_cache():
    print("ðŸ“¦ Scrubbing package cache...")
    try:
        p = subprocess.Popen(
            ["yay", "-Scc", "--noconfirm"], 
            stdin=subprocess.PIPE, 
            stdout=subprocess.DEVNULL, 
            stderr=subprocess.PIPE,
            text=True
        )
        p.communicate(input="y\ny\n")
    except Exception as e:
        print(f"   âš ï¸  Cache clean error: {e}")

    try:
        run_cmd(["yay", "-Yc", "--noconfirm"])
    except:
        pass

def vacuum_logs():
    print(f"ðŸ“œ Vacuuming journal logs to {LOG_LIMIT}...")
    run_cmd(["sudo", "journalctl", f"--vacuum-size={LOG_LIMIT}"])

def nuke_path_contents(path):
    full_path = os.path.expanduser(path)
    
    if not os.path.exists(full_path):
        return

    print(f"ðŸ’¥ Nuking contents of: {path}")

    try:
        items = glob.glob(os.path.join(full_path, "*"))
        for item in items:
            if os.path.isdir(item):
                shutil.rmtree(item)
            else:
                os.remove(item)
    except PermissionError:
        cmd = f"sudo rm -rf {full_path}/*"
        subprocess.run(cmd, shell=True, stderr=subprocess.PIPE)
    except Exception as e:
        print(f"   âš ï¸  Error cleaning {path}: {e}")

def run_custom_nukes():
    print("â˜¢ï¸  Processing custom nuke list...")
    for path in PATHS_TO_NUKE:
        nuke_path_contents(path)

def main():
    check_sudo_access()
    
    print("\n" + "="*40)
    print("ðŸ’€ S Y S T E M - C L E A N U P")
    print("="*40)
    print("Targets:")
    print(" - Recursive Orphans")
    print(" - Pacman/Yay Cache")
    print(" - System Logs")
    print(f" - Custom Paths ({len(PATHS_TO_NUKE)} directories)")
    print("-" * 40)

    start_free = get_free_space_mb()
    print(f"ðŸ’¾ Current Free Space: {format_size(start_free)}")
    print("-" * 40)

    confirm = input("âš ï¸  FULL WIPE. Type 'yes' to proceed: ").strip().lower()
    
    if confirm != "yes":
        print("âŒ Aborted. All goods.")
        sys.exit(0)

    print("\nðŸš€ Starting cleanup...")
    
    try:
        nuke_orphans()
        clean_pacman_cache()
        vacuum_logs()
        run_custom_nukes()
    except KeyboardInterrupt:
        print("\nðŸ›‘ Stopped by user.")
        sys.exit(1)

    end_free = get_free_space_mb()
    reclaimed = end_free - start_free

    print("\n" + "="*40)
    print("ðŸ”¥ DONE.")
    print(f"ðŸ’¾ Before: {format_size(start_free)}")
    print(f"ðŸ’¾ After : {format_size(end_free)}")
    
    if reclaimed > 0:
        print(f"ðŸŽ‰ Reclaimed: {format_size(reclaimed)}!")
    else:
        print("ðŸ¤” No space reclaimed.")
    
    print("="*40)

if __name__ == "__main__":
    main()
